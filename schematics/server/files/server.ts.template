/**
 * Bun SSR Server for Angular
 * Generated by @pegasusheavy/ngx-bun
 */

import { createBunServer, createBunAngularEngine, createStaticFileHandler } from '@pegasusheavy/ngx-bun';
import { join } from 'node:path';

// Import Angular bootstrap function
import bootstrap from './<%= sourceRoot %>/main.server';

// Paths
const browserDistFolder = join(import.meta.dir, 'dist/<%= project %>/browser');
const serverDistFolder = join(import.meta.dir, 'dist/<%= project %>/server');

// Create the Angular SSR engine
const engine = createBunAngularEngine({
  bootstrap,
  browserDistFolder,
  serverDistFolder,
  enableCache: process.env.NODE_ENV === 'production',
  maxCacheSize: 100,
  cacheTtl: 300_000, // 5 minutes
});

// Create static file handler
const staticHandler = createStaticFileHandler({
  root: browserDistFolder,
  compression: true,
});

// Create and start the server
const server = createBunServer({
  engine,
  staticHandler,
  port: <%= port %>,
  hostname: process.env.HOST || 'localhost',
  development: process.env.NODE_ENV !== 'production',
  logging: true,

  // Routes that should be served as client-only (no SSR)
  clientOnlyRoutes: [],

  // Callback when server starts
  onStart: (bunServer) => {
    console.log(`\nðŸ“¦ Angular SSR Server`);
    console.log(`   Port: ${bunServer.port}`);
    console.log(`   Environment: ${process.env.NODE_ENV || 'development'}`);
  },
});

// Handle graceful shutdown
process.on('SIGINT', () => {
  console.log('\nShutting down server...');
  server.stop();
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('\nShutting down server...');
  server.stop();
  process.exit(0);
});

export default server;
