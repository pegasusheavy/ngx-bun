name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^.{1,80}$
          subjectPatternError: |
            PR title must be 80 characters or less.
            Current title: "{title}"

  size-check:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build:all

      - name: Check package size
        run: |
          SIZE=$(npm pack --dry-run 2>&1 | grep "unpacked size" | awk '{print $NF}')
          echo "üì¶ Package size: $SIZE"

          # Extract numeric value (assuming KB or MB)
          VALUE=$(echo $SIZE | grep -oP '[0-9.]+')
          UNIT=$(echo $SIZE | grep -oP '[A-Za-z]+')

          # Convert to KB for comparison
          if [ "$UNIT" = "MB" ]; then
            VALUE_KB=$(echo "$VALUE * 1024" | bc)
          else
            VALUE_KB=$VALUE
          fi

          # Warn if over 1MB
          if (( $(echo "$VALUE_KB > 1024" | bc -l) )); then
            echo "‚ö†Ô∏è Warning: Package size exceeds 1MB"
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    # This job requires Dependency graph to be enabled in repo settings
    # Skip if not available
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
